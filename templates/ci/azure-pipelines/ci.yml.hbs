# Generated by ai-engineering v{{version}}
trigger:
  branches:
    include:
{{#each protectedBranches}}
      - {{this}}
{{/each}}

pr:
  branches:
    include:
{{#each protectedBranches}}
      - {{this}}
{{/each}}

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Quality
    jobs:
      - job: Build
        steps:
{{#ifIncludes stacks "typescript-react"}}
          - task: NodeTool@0
            inputs:
              versionSpec: "20.x"
          - script: npm ci
            displayName: Install dependencies
          - script: npm run lint
            displayName: Lint
          - script: npm run typecheck
            displayName: Type check
          - script: npm test -- --coverage
            displayName: Test
{{/ifIncludes}}
{{#ifIncludes stacks "dotnet"}}
          - task: UseDotNet@2
            inputs:
              packageType: sdk
              version: "8.0.x"
          - script: dotnet restore
            displayName: Restore
          - script: dotnet build --no-restore
            displayName: Build
          - script: dotnet test --no-build
            displayName: Test
{{/ifIncludes}}
{{#ifIncludes stacks "python"}}
          - task: UsePythonVersion@0
            inputs:
              versionSpec: "3.12"
          - script: pip install -r requirements.txt
            displayName: Install dependencies
          - script: ruff check .
            displayName: Lint
          - script: pytest --cov
            displayName: Test
{{/ifIncludes}}

  - stage: Security
    jobs:
      - job: Scan
        steps:
          - checkout: self
            fetchDepth: 0
          - script: |
              curl -sSfL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64 -o gitleaks
              chmod +x gitleaks
              ./gitleaks detect --no-banner
            displayName: Gitleaks scan

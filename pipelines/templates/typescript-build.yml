# =============================================================================
# TypeScript Build Template - AI Engineering Framework (Azure Pipelines)
# =============================================================================
# Reusable template for TypeScript projects: npm ci, lint, test with coverage,
# and build output.
#
# Usage:
#   steps:
#     - template: templates/typescript-build.yml
#       parameters:
#         workingDirectory: "src/frontend"
#         nodeVersion: "20"
# =============================================================================

parameters:
  # Working directory containing package.json
  - name: workingDirectory
    type: string
    default: "src/frontend"

  # Node.js version to use
  - name: nodeVersion
    type: string
    default: "20"

  # Whether to run linting
  - name: runLint
    type: boolean
    default: true

  # Whether to run tests (set to false in Build stage if tests ran in Test stage)
  - name: runTests
    type: boolean
    default: true

  # Whether to build the project
  - name: runBuild
    type: boolean
    default: true

  # Whether to publish build artifacts
  - name: publishArtifacts
    type: boolean
    default: true

  # Artifact name for published output
  - name: artifactName
    type: string
    default: "typescript-artifacts"

  # Build output directory (relative to workingDirectory)
  - name: buildOutputDir
    type: string
    default: "dist"

  # Custom npm build script name
  - name: buildScript
    type: string
    default: "build"

  # Custom npm test script name
  - name: testScript
    type: string
    default: "test"

steps:
  # ---------------------------------------------------------------------------
  # Setup
  # ---------------------------------------------------------------------------
  - task: NodeTool@0
    displayName: "Setup Node.js ${{ parameters.nodeVersion }}"
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}

  # ---------------------------------------------------------------------------
  # Install dependencies
  # ---------------------------------------------------------------------------
  - task: Cache@2
    displayName: "Cache npm packages"
    inputs:
      key: 'npm | "$(Agent.OS)" | ${{ parameters.workingDirectory }}/package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
      path: $(Pipeline.Workspace)/.npm

  - script: npm ci --cache $(Pipeline.Workspace)/.npm
    displayName: "Install npm dependencies (ci)"
    workingDirectory: ${{ parameters.workingDirectory }}

  # ---------------------------------------------------------------------------
  # Lint
  # ---------------------------------------------------------------------------
  - script: npx eslint . --max-warnings 0
    displayName: "Run ESLint"
    condition: eq('${{ parameters.runLint }}', 'true')
    workingDirectory: ${{ parameters.workingDirectory }}

  - script: npx prettier --check .
    displayName: "Run Prettier check"
    condition: eq('${{ parameters.runLint }}', 'true')
    workingDirectory: ${{ parameters.workingDirectory }}

  # ---------------------------------------------------------------------------
  # Test with coverage
  # ---------------------------------------------------------------------------
  - script: npx jest --coverage --ci --reporters=default --reporters=jest-junit
    displayName: "Run tests with coverage"
    condition: eq('${{ parameters.runTests }}', 'true')
    workingDirectory: ${{ parameters.workingDirectory }}
    env:
      JEST_JUNIT_OUTPUT_DIR: ${{ parameters.workingDirectory }}/test-results
      JEST_JUNIT_OUTPUT_NAME: junit.xml

  # Publish test results to Azure DevOps
  - task: PublishTestResults@2
    displayName: "Publish test results"
    condition: and(eq('${{ parameters.runTests }}', 'true'), always())
    inputs:
      testResultsFormat: JUnit
      testResultsFiles: "${{ parameters.workingDirectory }}/test-results/junit.xml"
      mergeTestResults: true
      failTaskOnFailedTests: true

  # Publish code coverage to Azure DevOps
  - task: PublishCodeCoverageResults@2
    displayName: "Publish code coverage"
    condition: and(eq('${{ parameters.runTests }}', 'true'), always())
    inputs:
      summaryFileLocation: "${{ parameters.workingDirectory }}/coverage/cobertura-coverage.xml"

  # ---------------------------------------------------------------------------
  # Build
  # ---------------------------------------------------------------------------
  - script: npm run ${{ parameters.buildScript }}
    displayName: "Build TypeScript project"
    condition: eq('${{ parameters.runBuild }}', 'true')
    workingDirectory: ${{ parameters.workingDirectory }}

  # ---------------------------------------------------------------------------
  # Publish artifacts
  # ---------------------------------------------------------------------------
  - task: CopyFiles@2
    displayName: "Copy build output to staging"
    condition: and(eq('${{ parameters.publishArtifacts }}', 'true'), eq('${{ parameters.runBuild }}', 'true'))
    inputs:
      SourceFolder: ${{ parameters.workingDirectory }}/${{ parameters.buildOutputDir }}
      Contents: "**"
      TargetFolder: $(Build.ArtifactStagingDirectory)/typescript

  - task: PublishBuildArtifacts@1
    displayName: "Upload artifacts"
    condition: and(eq('${{ parameters.publishArtifacts }}', 'true'), eq('${{ parameters.runBuild }}', 'true'))
    inputs:
      PathtoPublish: $(Build.ArtifactStagingDirectory)/typescript
      ArtifactName: ${{ parameters.artifactName }}

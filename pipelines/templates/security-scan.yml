# =============================================================================
# Security Scan Template - Azure Pipelines
# =============================================================================
# Reusable template for secret scanning, dependency scanning, and SAST.
# Usage:
#   steps:
#     - template: templates/security-scan.yml
#       parameters:
#         scanSecrets: true
#         scanDependencies: true
# =============================================================================

parameters:
  - name: scanSecrets
    type: boolean
    default: true
  - name: scanDependencies
    type: boolean
    default: true
  - name: snykToken
    type: string
    default: ''

steps:
  # --- Secret Scanning with gitleaks ---
  - ${{ if eq(parameters.scanSecrets, true) }}:
    - script: |
        if command -v gitleaks &> /dev/null; then
          gitleaks detect --source . --verbose --report-format sarif --report-path gitleaks-report.sarif
        else
          echo "Installing gitleaks..."
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep tag_name | cut -d '"' -f 4 | tr -d 'v')
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar xz
          chmod +x gitleaks
          ./gitleaks detect --source . --verbose --report-format sarif --report-path gitleaks-report.sarif
        fi
      displayName: 'Secret scanning (gitleaks)'
      continueOnError: false

    - task: PublishBuildArtifacts@1
      displayName: 'Upload gitleaks report'
      inputs:
        pathToPublish: 'gitleaks-report.sarif'
        artifactName: 'security-gitleaks'
      condition: always()

  # --- Dependency Scanning ---
  - ${{ if eq(parameters.scanDependencies, true) }}:
    - script: |
        if ls **/*.csproj 1> /dev/null 2>&1; then
          echo "Scanning .NET dependencies..."
          dotnet list package --vulnerable --include-transitive 2>&1 | tee dotnet-vulnerabilities.txt
        fi
      displayName: 'Scan .NET dependencies'
      continueOnError: true

    - script: |
        if [ -f package-lock.json ]; then
          echo "Scanning npm dependencies..."
          npm audit --json > npm-audit.json 2>&1 || true
          npm audit 2>&1 | tee npm-vulnerabilities.txt
        fi
      displayName: 'Scan npm dependencies'
      continueOnError: true

    - script: |
        if [ -f requirements.txt ] || [ -f pyproject.toml ]; then
          echo "Scanning Python dependencies..."
          pip install pip-audit 2>/dev/null
          pip-audit --format=json --output=pip-audit.json 2>&1 || true
          pip-audit 2>&1 | tee pip-vulnerabilities.txt
        fi
      displayName: 'Scan Python dependencies'
      continueOnError: true

    # Snyk (if token provided)
    - ${{ if ne(parameters.snykToken, '') }}:
      - script: |
          npm install -g snyk
          snyk auth ${{ parameters.snykToken }}
          snyk test --json > snyk-report.json 2>&1 || true
          snyk test 2>&1 | tee snyk-vulnerabilities.txt
        displayName: 'Snyk vulnerability scan'
        continueOnError: true

    - task: PublishBuildArtifacts@1
      displayName: 'Upload dependency scan reports'
      inputs:
        pathToPublish: '.'
        artifactName: 'security-dependencies'
      condition: always()

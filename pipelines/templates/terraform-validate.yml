# =============================================================================
# Terraform Validate Template - Azure Pipelines
# =============================================================================
# Reusable template for validating and planning Terraform configurations.
# Usage:
#   steps:
#     - template: templates/terraform-validate.yml
#       parameters:
#         workingDirectory: 'infrastructure/main'
# =============================================================================

parameters:
  - name: workingDirectory
    type: string
    default: 'infrastructure'
  - name: terraformVersion
    type: string
    default: 'latest'
  - name: runPlan
    type: boolean
    default: false
  - name: backendConfig
    type: string
    default: ''

steps:
  - task: TerraformInstaller@1
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '${{ parameters.terraformVersion }}'

  - script: terraform fmt -check -recursive
    displayName: 'Check Terraform formatting'
    workingDirectory: '${{ parameters.workingDirectory }}'

  - script: terraform init -backend=false
    displayName: 'Terraform init (validation only)'
    workingDirectory: '${{ parameters.workingDirectory }}'
    condition: eq('${{ parameters.backendConfig }}', '')

  - script: terraform init ${{ parameters.backendConfig }}
    displayName: 'Terraform init (with backend)'
    workingDirectory: '${{ parameters.workingDirectory }}'
    condition: ne('${{ parameters.backendConfig }}', '')

  - script: terraform validate
    displayName: 'Terraform validate'
    workingDirectory: '${{ parameters.workingDirectory }}'

  - script: |
      if command -v tflint &> /dev/null; then
        tflint --recursive
      else
        echo "tflint not installed, skipping"
      fi
    displayName: 'Run tflint'
    workingDirectory: '${{ parameters.workingDirectory }}'

  - ${{ if eq(parameters.runPlan, true) }}:
    - script: terraform plan -out=tfplan -input=false
      displayName: 'Terraform plan'
      workingDirectory: '${{ parameters.workingDirectory }}'

    - task: PublishBuildArtifacts@1
      displayName: 'Upload Terraform plan'
      inputs:
        pathToPublish: '${{ parameters.workingDirectory }}/tfplan'
        artifactName: 'terraform-plan'

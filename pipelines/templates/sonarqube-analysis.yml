# =============================================================================
# SonarQube Analysis Template - Azure Pipelines
# =============================================================================
# Reusable template for SonarQube/SonarCloud code quality analysis.
# Usage:
#   steps:
#     - template: templates/sonarqube-analysis.yml
#       parameters:
#         projectKey: 'my-project'
#         organization: 'my-org'  # Set for SonarCloud, omit for self-hosted
# =============================================================================

parameters:
  - name: projectKey
    type: string
  - name: organization
    type: string
    default: ''
  - name: extraProperties
    type: string
    default: ''

steps:
  # --- SonarCloud (organization provided) ---
  - ${{ if ne(parameters.organization, '') }}:
    - task: SonarCloudPrepare@2
      displayName: 'Prepare SonarCloud analysis'
      inputs:
        SonarCloud: 'SonarCloud'
        organization: '${{ parameters.organization }}'
        scannerMode: 'CLI'
        configMode: 'manual'
        cliProjectKey: '${{ parameters.projectKey }}'
        cliSources: 'src'
        extraProperties: |
          sonar.exclusions=**/node_modules/**,**/bin/**,**/obj/**,**/*.generated.cs
          sonar.cs.opencover.reportsPaths=**/coverage.opencover.xml
          sonar.javascript.lcov.reportPaths=coverage/lcov.info
          sonar.python.coverage.reportPaths=coverage.xml
          sonar.qualitygate.wait=true
          ${{ parameters.extraProperties }}

    - task: SonarCloudAnalyze@2
      displayName: 'Run SonarCloud analysis'

    - task: SonarCloudPublish@2
      displayName: 'Publish SonarCloud quality gate result'
      inputs:
        pollingTimeoutSec: '300'

  # --- Self-hosted SonarQube (no organization) ---
  - ${{ if eq(parameters.organization, '') }}:
    - task: SonarQubePrepare@6
      displayName: 'Prepare SonarQube analysis'
      inputs:
        SonarQube: 'SonarQube'
        scannerMode: 'CLI'
        configMode: 'manual'
        cliProjectKey: '${{ parameters.projectKey }}'
        cliSources: 'src'
        extraProperties: |
          sonar.exclusions=**/node_modules/**,**/bin/**,**/obj/**
          sonar.qualitygate.wait=true
          ${{ parameters.extraProperties }}

    - task: SonarQubeAnalyze@6
      displayName: 'Run SonarQube analysis'

    - task: SonarQubePublish@6
      displayName: 'Publish SonarQube quality gate result'
      inputs:
        pollingTimeoutSec: '300'

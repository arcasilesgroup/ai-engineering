# =============================================================================
# CI Pipeline - AI Engineering Framework
# =============================================================================
# Multi-stack continuous integration workflow that supports .NET, TypeScript,
# Python, and Infrastructure (Terraform) projects.
#
# CUSTOMIZATION GUIDE:
#   1. Update the matrix strategy to include only your project's stacks
#   2. Adjust paths-ignore to exclude directories that don't need CI
#   3. Set the appropriate versions for your runtime environments
#   4. Configure caching paths to match your project structure
# =============================================================================

name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/ISSUE_TEMPLATE/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/ISSUE_TEMPLATE/**"

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# ---------------------------------------------------------------------------
# Environment variables shared across all jobs
# CUSTOMIZE: Update these to match your project
# ---------------------------------------------------------------------------
env:
  DOTNET_VERSION: "8.0.x"
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  # CUSTOMIZE: Set to your solution file path for .NET projects
  DOTNET_SOLUTION: "src/**/*.sln"
  # CUSTOMIZE: Set to your TypeScript project working directory
  TS_WORKING_DIR: "src/frontend"
  # CUSTOMIZE: Set to your Python project working directory
  PYTHON_WORKING_DIR: "src"

jobs:
  # ===========================================================================
  # Lint - Run linters for each stack
  # ===========================================================================
  lint:
    name: "Lint (${{ matrix.stack }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # CUSTOMIZE: Include only the stacks your project uses
        stack: [dotnet, typescript, python, terraform]
        include:
          - stack: dotnet
            dotnet: true
          - stack: typescript
            node: true
          - stack: python
            python: true
          - stack: terraform
            terraform: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # .NET Linting
      # -----------------------------------------------------------------------
      - name: Setup .NET
        if: matrix.dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        if: matrix.dotnet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: .NET format check
        if: matrix.dotnet
        run: |
          dotnet restore
          dotnet format --verify-no-changes --verbosity diagnostic

      # -----------------------------------------------------------------------
      # TypeScript Linting
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        if: matrix.node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          # CUSTOMIZE: Point to the directory containing package-lock.json
          cache-dependency-path: "${{ env.TS_WORKING_DIR }}/package-lock.json"

      - name: Install npm dependencies
        if: matrix.node
        working-directory: ${{ env.TS_WORKING_DIR }}
        run: npm ci

      - name: Run ESLint
        if: matrix.node
        working-directory: ${{ env.TS_WORKING_DIR }}
        run: npx eslint . --max-warnings 0

      - name: Run Prettier check
        if: matrix.node
        working-directory: ${{ env.TS_WORKING_DIR }}
        run: npx prettier --check .

      # -----------------------------------------------------------------------
      # Python Linting
      # -----------------------------------------------------------------------
      - name: Setup Python
        if: matrix.python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        if: matrix.python
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install Python linting tools
        if: matrix.python
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff linter
        if: matrix.python
        run: ruff check ${{ env.PYTHON_WORKING_DIR }}/

      - name: Run Ruff format check
        if: matrix.python
        run: ruff format --check ${{ env.PYTHON_WORKING_DIR }}/

      # -----------------------------------------------------------------------
      # Terraform Linting
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        if: matrix.terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform format check
        if: matrix.terraform
        run: terraform fmt -check -recursive

  # ===========================================================================
  # Test - Run tests with coverage for each stack
  # ===========================================================================
  test:
    name: "Test (${{ matrix.stack }})"
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        # CUSTOMIZE: Include only the stacks your project uses
        stack: [dotnet, typescript, python]
        include:
          - stack: dotnet
            dotnet: true
          - stack: typescript
            node: true
          - stack: python
            python: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # .NET Testing
      # -----------------------------------------------------------------------
      - name: Setup .NET
        if: matrix.dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        if: matrix.dotnet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore .NET dependencies
        if: matrix.dotnet
        run: dotnet restore

      - name: Run .NET tests with coverage
        if: matrix.dotnet
        run: |
          dotnet test \
            --no-restore \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./test-results \
            --logger "trx;LogFileName=test-results.trx" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: Upload .NET test results
        if: matrix.dotnet && always()
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-test-results
          path: ./test-results/

      # -----------------------------------------------------------------------
      # TypeScript Testing
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        if: matrix.node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "${{ env.TS_WORKING_DIR }}/package-lock.json"

      - name: Install npm dependencies
        if: matrix.node
        working-directory: ${{ env.TS_WORKING_DIR }}
        run: npm ci

      - name: Run TypeScript tests with coverage
        if: matrix.node
        working-directory: ${{ env.TS_WORKING_DIR }}
        run: npx jest --coverage --ci --reporters=default --reporters=jest-junit
        env:
          JEST_JUNIT_OUTPUT_DIR: ./test-results

      - name: Upload TypeScript test results
        if: matrix.node && always()
        uses: actions/upload-artifact@v4
        with:
          name: typescript-test-results
          path: ${{ env.TS_WORKING_DIR }}/test-results/

      - name: Upload TypeScript coverage
        if: matrix.node && always()
        uses: actions/upload-artifact@v4
        with:
          name: typescript-coverage
          path: ${{ env.TS_WORKING_DIR }}/coverage/

      # -----------------------------------------------------------------------
      # Python Testing
      # -----------------------------------------------------------------------
      - name: Setup Python
        if: matrix.python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        if: matrix.python
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install Python dependencies
        if: matrix.python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest with coverage
        if: matrix.python
        run: |
          pytest tests/ \
            --verbose \
            --cov=${{ env.PYTHON_WORKING_DIR }} \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --junitxml=test-results/pytest-results.xml

      - name: Upload Python test results
        if: matrix.python && always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-results
          path: test-results/

      - name: Upload Python coverage
        if: matrix.python && always()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: coverage.xml

  # ===========================================================================
  # Build - Build artifacts for each stack
  # ===========================================================================
  build:
    name: "Build (${{ matrix.stack }})"
    runs-on: ubuntu-latest
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        # CUSTOMIZE: Include only the stacks your project uses
        stack: [dotnet, typescript, python]
        include:
          - stack: dotnet
            dotnet: true
          - stack: typescript
            node: true
          - stack: python
            python: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # .NET Build
      # -----------------------------------------------------------------------
      - name: Setup .NET
        if: matrix.dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        if: matrix.dotnet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Build .NET solution
        if: matrix.dotnet
        run: |
          dotnet restore
          dotnet build --no-restore --configuration Release

      - name: Publish .NET artifacts
        if: matrix.dotnet
        run: dotnet publish --no-build --configuration Release --output ./publish

      - name: Upload .NET artifacts
        if: matrix.dotnet
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-artifacts
          path: ./publish/
          retention-days: 30

      # -----------------------------------------------------------------------
      # TypeScript Build
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        if: matrix.node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "${{ env.TS_WORKING_DIR }}/package-lock.json"

      - name: Install npm dependencies
        if: matrix.node
        working-directory: ${{ env.TS_WORKING_DIR }}
        run: npm ci

      - name: Build TypeScript project
        if: matrix.node
        working-directory: ${{ env.TS_WORKING_DIR }}
        run: npm run build

      - name: Upload TypeScript artifacts
        if: matrix.node
        uses: actions/upload-artifact@v4
        with:
          name: typescript-artifacts
          # CUSTOMIZE: Update to your build output directory
          path: ${{ env.TS_WORKING_DIR }}/dist/
          retention-days: 30

      # -----------------------------------------------------------------------
      # Python Build
      # -----------------------------------------------------------------------
      - name: Setup Python
        if: matrix.python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python build tools
        if: matrix.python
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build Python package
        if: matrix.python
        run: python -m build

      - name: Validate Python package
        if: matrix.python
        run: twine check dist/*

      - name: Upload Python artifacts
        if: matrix.python
        uses: actions/upload-artifact@v4
        with:
          name: python-artifacts
          path: dist/
          retention-days: 30

#!/usr/bin/env bash
# =============================================================================
# Pre-Push Hook: Vulnerability Check
# =============================================================================
# Validates dependencies against GitHub Advisory Database before pushing.
#
# Policy:
#   - CRITICAL vulnerabilities: BLOCK push
#   - HIGH vulnerabilities: WARN but allow push
#   - MEDIUM/LOW: Ignore (reported in CI)
#
# Bypass (NOT recommended): git push --no-verify
# =============================================================================

set -uo pipefail

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ğŸ” Checking dependencies for vulnerabilities...${NC}"

HAS_CRITICAL=false
HAS_HIGH=false
CHECKED_SOMETHING=false

# -----------------------------------------------------------------------------
# .NET Projects
# -----------------------------------------------------------------------------
if ls ./*.csproj ./*.sln 1>/dev/null 2>&1; then
    CHECKED_SOMETHING=true
    echo -e "  Checking .NET packages..."

    # dotnet list package --vulnerable requires restore first
    if ! dotnet restore --verbosity quiet 2>/dev/null; then
        echo -e "  ${YELLOW}âš ${NC}  dotnet restore failed, skipping .NET vulnerability check"
    else
        VULN_OUTPUT=$(dotnet list package --vulnerable --include-transitive 2>&1 || true)

        if echo "$VULN_OUTPUT" | grep -qi "critical"; then
            echo -e "  ${RED}âŒ${NC} CRITICAL vulnerabilities found in .NET dependencies"
            HAS_CRITICAL=true
        elif echo "$VULN_OUTPUT" | grep -qi "high"; then
            echo -e "  ${YELLOW}âš ${NC}  HIGH vulnerabilities found in .NET dependencies (warning)"
            HAS_HIGH=true
        else
            echo -e "  ${GREEN}âœ“${NC}  No critical/high vulnerabilities in .NET packages"
        fi
    fi
fi

# -----------------------------------------------------------------------------
# TypeScript/Node Projects
# -----------------------------------------------------------------------------
if [[ -f "package-lock.json" ]]; then
    CHECKED_SOMETHING=true
    echo -e "  Checking npm packages..."

    # npm audit returns exit code based on severity threshold
    # --audit-level=critical only fails on critical
    if ! npm audit --audit-level=critical 2>/dev/null 1>/dev/null; then
        echo -e "  ${RED}âŒ${NC} CRITICAL vulnerabilities found in npm dependencies"
        HAS_CRITICAL=true
    elif ! npm audit --audit-level=high 2>/dev/null 1>/dev/null; then
        echo -e "  ${YELLOW}âš ${NC}  HIGH vulnerabilities found in npm dependencies (warning)"
        HAS_HIGH=true
    else
        echo -e "  ${GREEN}âœ“${NC}  No critical/high vulnerabilities in npm packages"
    fi
elif [[ -f "yarn.lock" ]]; then
    CHECKED_SOMETHING=true
    echo -e "  Checking yarn packages..."

    if command -v yarn &>/dev/null; then
        # yarn audit has different output format
        AUDIT_OUTPUT=$(yarn audit --level critical 2>&1 || true)
        if echo "$AUDIT_OUTPUT" | grep -qi "critical"; then
            echo -e "  ${RED}âŒ${NC} CRITICAL vulnerabilities found in yarn dependencies"
            HAS_CRITICAL=true
        elif yarn audit --level high 2>&1 | grep -qi "high"; then
            echo -e "  ${YELLOW}âš ${NC}  HIGH vulnerabilities found in yarn dependencies (warning)"
            HAS_HIGH=true
        else
            echo -e "  ${GREEN}âœ“${NC}  No critical/high vulnerabilities in yarn packages"
        fi
    fi
elif [[ -f "pnpm-lock.yaml" ]]; then
    CHECKED_SOMETHING=true
    echo -e "  Checking pnpm packages..."

    if command -v pnpm &>/dev/null; then
        if ! pnpm audit --audit-level=critical 2>/dev/null 1>/dev/null; then
            echo -e "  ${RED}âŒ${NC} CRITICAL vulnerabilities found in pnpm dependencies"
            HAS_CRITICAL=true
        elif ! pnpm audit --audit-level=high 2>/dev/null 1>/dev/null; then
            echo -e "  ${YELLOW}âš ${NC}  HIGH vulnerabilities found in pnpm dependencies (warning)"
            HAS_HIGH=true
        else
            echo -e "  ${GREEN}âœ“${NC}  No critical/high vulnerabilities in pnpm packages"
        fi
    fi
fi

# -----------------------------------------------------------------------------
# Python Projects
# -----------------------------------------------------------------------------
if [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]]; then
    CHECKED_SOMETHING=true
    echo -e "  Checking Python packages..."

    if command -v pip-audit &>/dev/null; then
        # pip-audit doesn't have built-in severity filtering, parse output
        AUDIT_OUTPUT=$(pip-audit --progress-spinner off 2>&1 || true)

        if echo "$AUDIT_OUTPUT" | grep -qi "critical"; then
            echo -e "  ${RED}âŒ${NC} CRITICAL vulnerabilities found in Python dependencies"
            HAS_CRITICAL=true
        elif echo "$AUDIT_OUTPUT" | grep -qi "high"; then
            echo -e "  ${YELLOW}âš ${NC}  HIGH vulnerabilities found in Python dependencies (warning)"
            HAS_HIGH=true
        elif echo "$AUDIT_OUTPUT" | grep -q "No known vulnerabilities found"; then
            echo -e "  ${GREEN}âœ“${NC}  No known vulnerabilities in Python packages"
        else
            # pip-audit found something but couldn't determine severity
            echo -e "  ${YELLOW}âš ${NC}  pip-audit found issues (check manually)"
        fi
    else
        echo -e "  ${YELLOW}âš ${NC}  pip-audit not installed, skipping Python vulnerability check"
        echo -e "      Install with: pip install pip-audit"
    fi
fi

# -----------------------------------------------------------------------------
# Check GitHub Dependabot Alerts (if gh CLI available)
# -----------------------------------------------------------------------------
check_github_advisories() {
    if ! command -v gh &>/dev/null; then
        return 0
    fi

    # Check if we're authenticated
    if ! gh auth status &>/dev/null 2>&1; then
        return 0
    fi

    # Get repo info from git remote
    REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || echo "")
    if [[ -z "$REPO" ]]; then
        return 0
    fi

    # Query Dependabot alerts (requires appropriate permissions)
    ALERTS=$(gh api "/repos/$REPO/dependabot/alerts?state=open&severity=critical,high" 2>/dev/null || echo "[]")

    # Count alerts
    if command -v jq &>/dev/null; then
        COUNT=$(echo "$ALERTS" | jq 'length' 2>/dev/null || echo "0")
    else
        COUNT=$(echo "$ALERTS" | grep -c '"number"' || echo "0")
    fi

    if [[ "$COUNT" -gt 0 && "$COUNT" != "0" ]]; then
        echo ""
        echo -e "  ${YELLOW}ğŸ“‹${NC} $COUNT open critical/high Dependabot alerts in this repo"
        echo -e "      View: https://github.com/$REPO/security/dependabot"
    fi
}

# Run GitHub advisory check in background (non-blocking)
check_github_advisories &

# -----------------------------------------------------------------------------
# Decision
# -----------------------------------------------------------------------------
echo ""

if [[ "$CHECKED_SOMETHING" == false ]]; then
    echo -e "${GREEN}âœ… No dependency files found to check${NC}"
    exit 0
fi

# Wait for background GitHub check
wait

if [[ "$HAS_CRITICAL" == true ]]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  ğŸš« Push BLOCKED due to CRITICAL vulnerabilities              â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "Fix critical vulnerabilities before pushing:"
    echo -e "  â€¢ npm:    ${BLUE}npm audit fix${NC} or ${BLUE}npm update <package>${NC}"
    echo -e "  â€¢ dotnet: ${BLUE}dotnet restore${NC} (updates to patched versions)"
    echo -e "  â€¢ python: ${BLUE}pip install --upgrade <package>${NC}"
    echo ""
    echo -e "Review details:"
    echo -e "  â€¢ npm:    ${BLUE}npm audit${NC}"
    echo -e "  â€¢ dotnet: ${BLUE}dotnet list package --vulnerable${NC}"
    echo -e "  â€¢ python: ${BLUE}pip-audit${NC}"
    echo ""
    echo -e "${YELLOW}Bypass (NOT recommended):${NC} ${BLUE}git push --no-verify${NC}"
    exit 1
fi

if [[ "$HAS_HIGH" == true ]]; then
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘  âš ï¸  Push allowed with HIGH severity warnings                 â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "Consider fixing HIGH vulnerabilities soon."
    echo -e "CI pipeline will report these in PR checks."
fi

echo -e "${GREEN}âœ… No critical vulnerabilities - push allowed${NC}"
exit 0
